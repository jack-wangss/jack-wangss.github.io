---
layout: post
title: "FOCG5: 5.表面着色"
subtitle: "FOCG5: 5 Surface Shading"
background: '/img/posts/01.jpg'
---

用与计算着色的方程叫做着色模型（shading model），针对不同的应用，有很多不同的着色模型。着色模型相对独立，一些模型既可以用在光线追踪系统，也能用在着色系统中。本章主要介绍一个基于点光源的简单着色模型。


## 5.1 点状光源

真实世界中，表面的光来自各个方向。但是对于模型的照明，最简单的场景是光源来自一个方向。这个比较理想化，但也提供了一个实用的小光源模型。可能光源确实很小，也可能是距离太远。点状光源有两个特性：点光源足够小，可以当作一个点，距离表面的远近会影响照明效果；定向光源同样足够小，同时距离物体很远，且距离不会影响照明效果，所以不需要关注定向光源的位置，只需要关注其方向。这两个类型的光源就像是手电筒和太阳。

### 5.1.1 点光源照明

点光源由其位置和强度定义。点光源可以是各向同性的`isotropic`，意味着所有方向的能量相等，也有一些系统提供类似射灯的光源，只会向固定方向发光。

对于各向同性的点光源，很容易计算表面接受的光量。例如我们有这样一个发射1瓦特能量的光源，我们把它放到一个半径1m的空心球中，所有在球内表面的能量均匀的分布在面积为$4\pi m^2$的表面，所以每平方米的能量密度是 $1/(4\pi)$。这个密度叫辐照度（irradiance）,是一个用来描述光照射到表面数量的量，我们用它来计算光的反射。

一般情况下，光源的能量为P，接受的球半径为r，则irradiance E为：

$$ E=\frac{P}{4\pi}\frac{1}{r^2}=\frac{I}{r^2}$$

$I=P/ 4\pi$ 代表光源的强度，它是光源自身的属性，与照明的表面形状无关。$r^{-2}$一般叫做平方反比，描述irradiance与光源到表面距离r的关系。

计算irradiance还需要考虑的问题是入射角（angle of incidence），面法向和光线方向的夹角。如图5.2，面法向与光线方向一致时，表面接收了全部的光线；将面倾斜60°时，只接受到了一半的光线。转动$\theta$ 度所接收的能量与 $\cos \theta $成正比。因为面积没有变化，所有irradiance（每单位面积的辐射能量）也和同样的因子成正比。这就是`Lamber's cosine law`，因为Johann Heinrich Lambert在他1760年的书 `Photometria`提出。

<div style="text-align: center">
<img src="/img/posts/5 Surface Shading/1.png"/>
</div>

结合上述内容，我们得到以下公式：

$$ E=I\frac{\cos \theta}{r^2}$$

$\cos \theta/r^2$ 为点光源的几何因子（geometry factor），它由点光源和接受面的几何关系所决定。

在实践中，角度 $\theta$ 不是用传统的方式计算出来的。已知面法向的单位向量n和光线方向l，可以通过点乘方式计算余弦值：

$$\cos \theta =n \cdot l$$

这比用三角函数去计算更简单、更高效。

### 5.1.2 定向光源照明

定向光源可以看成是一个非常亮的、且距离非常远的点光源。由于距离很远，原来公式中的$I/r^2$会接近于0，所以对于定向光源，我们用一个常量H代替：

$$E=H \cos \theta$$

这个常量可以叫做一般辐照度（normal irradiance），因为当光线方向等于面法向方向时，它就等于irradiance。定向光源的照明不会因为距离而削弱。

## 5.2 基本反射模型

现在我们已经能够计算irradiance，也就是计算有多少光落到物体上，现在我们还需要知道这些物体如何反射光。反射光的计算与物体的材质相关，本章我们介绍一个简单的模型，基于有光泽表面和颜色的材质。材质有基本层决定了覆盖对象的颜色，同时有一个提供反射的表面。

### 5.2.1 朗博反射 Lambertian reflection

最简单的一种反射类型是一个表面上均等的向所有方向反射光，且与方向的来源无关，所以被观察到的反射光$L_r$就等于irradiance的常数倍：

$$L_r=kE$$

这样的表面叫做理想漫反射表面（ideal diffuse surface），所有方向的亮度相等；其颜色与视角无关，完全取决于反射率（reflectance）R。与入射光相关的反射系数为$R/\pi$（为什么是$\pi$，会在第十四章介绍）：

$$L_r= \frac{R}{\pi} E$$

对于不同颜色的光，反射率也是不一样的。简单的颜色模型，只需要三种反射率分别处理红、绿、蓝。

理想的漫反射着色，一般被称为Lambertian着色，因为Lambertian的余弦定理是它建模的主要效果，它本身提供一个平的白垩外观。在物理上，它模拟了在材料内部反弹的光，以便“获取”它来自哪里并在各个方向随机出现。 对于纸张、平面涂料、泥土、树皮、石头和其他没有足够光滑的表面来产生明显的光泽反射效果的粗糙材料，这是一种有效的模型。

### 5.2.2 镜面反射 Specular reflection

很多材质有不同程度的光泽，例如金属、玻璃、半光泽的涂料，或是很多植物的叶子。当你观察这些材质时，你会发现反射会随着你的视点变化。相对于Lambertian反射的与视角无关，镜面反射是与视角相关的。

最简单的镜面反射发生在非常光滑的表面，比如镜面或水面，光线接近镜像一样的直接反射，这种叫做理想镜面反射（ideal specular reflection），通常会当作一种特殊情况去处理。更多的表面不会像这样完美的平滑，叫做光泽反射（glossy reflection）。关于光泽反射的模型有很多，会在第14章进行讨论。这里介绍一种简单通用的模型，1975年由Phong提出，1976年由Blinn和其他人进一步更新，叫做Modified Blinn-Phong模型。

由于镜面反射是视角相关的，所以这是一个与视角方向v，法向量n，光线方向l相关的函数。光线方向的对称方向和v越接近，反射的光就越多。

我们可以用half vector的思路来判断他们的接近程度，也就是通过判断l和v的half vector h是否接近法向量n，可以通过n和h的点乘结果去判断。（向量相等时结果为1）：

$$(n\cdot h)^p$$

<div style="text-align: center">
<img src="/img/posts/5 Surface Shading/2.png"/>
</div>

Phong的指数p使反射的光递减时更加明显。half vector的计算也很简单：由于v和l的长度一样，所以他们的和就是半程向量，最后进行归一化处理即可。

$$ h= \frac{l+v}{||l+v||}$$

<div style="text-align: center">
<img src="/img/posts/5 Surface Shading/3.png"/>
</div>

